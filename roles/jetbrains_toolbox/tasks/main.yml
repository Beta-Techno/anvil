---
- name: Skip JetBrains Toolbox when disabled
  ansible.builtin.debug:
    msg: "JetBrains Toolbox install skipped (jetbrains_toolbox_install=false)."
  when: not jetbrains_toolbox_install

- name: Set Toolbox URL when provided
  ansible.builtin.set_fact:
    jetbrains_toolbox_resolved_url: "{{ jetbrains_toolbox_download_url }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length > 0

- name: Resolve architecture key for Toolbox download
  ansible.builtin.set_fact:
    jetbrains_toolbox_arch_key: "{{ jetbrains_toolbox_arch_map[ansible_architecture] | default('') }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Fail if architecture not supported
  ansible.builtin.fail:
    msg: "Unsupported architecture for JetBrains Toolbox: {{ ansible_architecture }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0
    - jetbrains_toolbox_arch_key | length == 0

- name: Fetch Toolbox release metadata (latest)
  ansible.builtin.uri:
    url: https://data.services.jetbrains.com/products/releases?code=TBA&latest=true&type=release
    return_content: true
  register: toolbox_release
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Parse and set Toolbox download URL from metadata
  ansible.builtin.set_fact:
    jetbrains_toolbox_resolved_url: >-
      {{
        (
          (toolbox_release.content | from_json).TBA[0].downloads[jetbrains_toolbox_arch_key].link
          | default((toolbox_release.content | from_json).TBA[0].downloads['linux'].link | default(''))
        )
      }}
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Fail if Toolbox URL could not be resolved
  ansible.builtin.fail:
    msg: "Could not resolve JetBrains Toolbox download URL."
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_resolved_url is not defined or jetbrains_toolbox_resolved_url | length == 0

- name: Download JetBrains Toolbox archive
  ansible.builtin.get_url:
    url: "{{ jetbrains_toolbox_resolved_url }}"
    dest: /tmp/jetbrains-toolbox.tar.gz
    mode: "0644"
    checksum: "{{ jetbrains_toolbox_checksum if jetbrains_toolbox_checksum | length > 0 else omit }}"
  register: toolbox_download
  failed_when: toolbox_download.status is defined and toolbox_download.status not in [200, 304]
  when: jetbrains_toolbox_install

- name: Skip Toolbox install when download failed
  ansible.builtin.debug:
    msg: "JetBrains Toolbox download failed (status={{ toolbox_download.status | default('unknown') }}); skipping launch."
  when:
    - jetbrains_toolbox_install
    - toolbox_download is defined
    - toolbox_download.failed | default(false)
  changed_when: false

- name: Extract JetBrains Toolbox archive
  ansible.builtin.unarchive:
    src: /tmp/jetbrains-toolbox.tar.gz
    dest: /tmp/jetbrains-toolbox-extract
    remote_src: true
  when: jetbrains_toolbox_install

- name: Find JetBrains Toolbox binary
  ansible.builtin.find:
    paths: /tmp/jetbrains-toolbox-extract
    patterns: jetbrains-toolbox
    file_type: file
  register: toolbox_find
  when: jetbrains_toolbox_install

- name: Skip JetBrains Toolbox launch when binary not found
  ansible.builtin.debug:
    msg: "JetBrains Toolbox binary not found in extracted archive; skipping launch."
  when:
    - jetbrains_toolbox_install
    - toolbox_find.files | length == 0
  changed_when: false

- name: Launch JetBrains Toolbox installer
  ansible.builtin.shell: |
    set -e
    setsid "{{ toolbox_find.files[0].path }}" >/dev/null 2>&1 < /dev/null & disown || true
  args:
    executable: /bin/bash
  register: toolbox_result
  changed_when: true
  become: false
  when:
    - jetbrains_toolbox_install
    - toolbox_download is defined
    - not toolbox_download.failed | default(false)
    - toolbox_find.files | length > 0

- name: Remove downloaded JetBrains Toolbox archive
  ansible.builtin.file:
    path: /tmp/jetbrains-toolbox.tar.gz
    state: absent
  when: jetbrains_toolbox_install

- name: Remove extracted JetBrains Toolbox directory
  ansible.builtin.file:
    path: /tmp/jetbrains-toolbox-extract
    state: absent
  when: jetbrains_toolbox_install

- name: JetBrains Toolbox summary
  ansible.builtin.debug:
    msg: "JetBrains Toolbox install attempted (jetbrains_toolbox_install={{ jetbrains_toolbox_install }})."
  when: jetbrains_toolbox_install
