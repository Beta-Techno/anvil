---
- name: Skip JetBrains Toolbox when disabled
  ansible.builtin.debug:
    msg: "JetBrains Toolbox install skipped (jetbrains_toolbox_install=false)."
  when: not jetbrains_toolbox_install

- name: Set Toolbox URL when provided
  ansible.builtin.set_fact:
    jetbrains_toolbox_resolved_url: "{{ jetbrains_toolbox_download_url }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length > 0

- name: Resolve architecture key for Toolbox download
  ansible.builtin.set_fact:
    jetbrains_toolbox_arch_key: "{{ jetbrains_toolbox_arch_map[ansible_architecture] | default('') }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Fail if architecture not supported
  ansible.builtin.fail:
    msg: "Unsupported architecture for JetBrains Toolbox: {{ ansible_architecture }}"
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0
    - jetbrains_toolbox_arch_key | length == 0

- name: Fetch Toolbox release metadata (latest)
  ansible.builtin.uri:
    url: https://data.services.jetbrains.com/products/releases?code=TBA&latest=true&type=release
    return_content: true
  register: toolbox_release
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Parse and set Toolbox download URL from metadata
  ansible.builtin.set_fact:
    jetbrains_toolbox_resolved_url: >-
      {{
        (
          (toolbox_release.content | from_json).TBA[0].downloads[jetbrains_toolbox_arch_key].link
          | default((toolbox_release.content | from_json).TBA[0].downloads['linux'].link | default(''))
        )
      }}
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_download_url | length == 0

- name: Fail if Toolbox URL could not be resolved
  ansible.builtin.fail:
    msg: "Could not resolve JetBrains Toolbox download URL."
  when:
    - jetbrains_toolbox_install
    - jetbrains_toolbox_resolved_url is not defined or jetbrains_toolbox_resolved_url | length == 0

- name: Download JetBrains Toolbox archive
  ansible.builtin.get_url:
    url: "{{ jetbrains_toolbox_resolved_url }}"
    dest: /tmp/jetbrains-toolbox.tar.gz
    mode: "0644"
    checksum: "{{ jetbrains_toolbox_checksum if jetbrains_toolbox_checksum | length > 0 else omit }}"
  when: jetbrains_toolbox_install

- name: Extract and launch JetBrains Toolbox installer
  ansible.builtin.shell: |
    set -e
    tmp="$(mktemp -d)"
    trap 'rm -rf "$tmp"' EXIT
    tar -xzf /tmp/jetbrains-toolbox.tar.gz -C "$tmp"
    dir="$(find "$tmp" -maxdepth 1 -type d -name 'jetbrains-toolbox*' | head -n1)"
    chmod +x "$dir/jetbrains-toolbox"
    setsid "$dir/jetbrains-toolbox" >/dev/null 2>&1 & disown || true
  args:
    executable: /bin/bash
  register: toolbox_result
  changed_when: true
  become: false
  when: jetbrains_toolbox_install

- name: Remove downloaded JetBrains Toolbox archive
  ansible.builtin.file:
    path: /tmp/jetbrains-toolbox.tar.gz
    state: absent
  when: jetbrains_toolbox_install

- name: JetBrains Toolbox summary
  ansible.builtin.debug:
    msg: "JetBrains Toolbox install attempted (jetbrains_toolbox_install={{ jetbrains_toolbox_install }})."
  when: jetbrains_toolbox_install
