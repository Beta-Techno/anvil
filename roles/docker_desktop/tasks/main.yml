---
- name: Track Docker Desktop install intent
  ansible.builtin.set_fact:
    docker_desktop_should_install: "{{ docker_desktop_install }}"

- name: Skip Docker Desktop when disabled
  ansible.builtin.debug:
    msg: "Docker Desktop install skipped (docker_desktop_install=false)."
  when: not docker_desktop_should_install

- name: Check virtualization environment
  ansible.builtin.command: systemd-detect-virt
  register: dd_virt
  changed_when: false
  failed_when: false
  when: docker_desktop_should_install

- name: Disable Docker Desktop inside virtualization
  ansible.builtin.set_fact:
    docker_desktop_should_install: false
  when:
    - docker_desktop_should_install
    - dd_virt.stdout | lower not in ['', 'none']

- name: Log virtualization skip reason
  ansible.builtin.debug:
    msg: "Docker Desktop skipped: virtualization '{{ dd_virt.stdout }}' detected."
  when:
    - not docker_desktop_should_install
    - dd_virt is defined
    - dd_virt.stdout | lower not in ['', 'none']

- name: Ensure KVM device exists
  ansible.builtin.stat:
    path: /dev/kvm
  register: kvm_stat
  when: docker_desktop_should_install

- name: Disable when KVM not available
  ansible.builtin.set_fact:
    docker_desktop_should_install: false
  when:
    - docker_desktop_should_install
    - (kvm_stat.stat.exists | default(false)) | bool == false

- name: Log missing KVM skip
  ansible.builtin.debug:
    msg: "Docker Desktop skipped: /dev/kvm missing."
  when:
    - not docker_desktop_should_install
    - kvm_stat is defined
    - (kvm_stat.stat.exists | default(false)) | bool == false

- name: Check if Docker Desktop is already installed
  ansible.builtin.command: dpkg -l docker-desktop
  register: docker_desktop_check
  changed_when: false
  failed_when: false
  when: docker_desktop_should_install

- name: Skip Docker Desktop if already installed
  ansible.builtin.debug:
    msg: "Docker Desktop already installed, skipping."
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc == 0

- name: Download Docker Desktop package
  ansible.builtin.get_url:
    url: "{{ docker_desktop_urls[apt_arch] }}"
    dest: /tmp/docker-desktop.deb
    mode: "0644"
    checksum: "{{ docker_desktop_checksum if docker_desktop_checksum | length > 0 else omit }}"
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc != 0

- name: Install Docker Desktop
  ansible.builtin.apt:
    deb: /tmp/docker-desktop.deb
    state: present
    update_cache: true
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc != 0

- name: Add user to kvm group for Docker Desktop
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: kvm
    append: true
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc != 0

- name: Enable user linger for Docker Desktop
  ansible.builtin.command: loginctl enable-linger "{{ ansible_user_id }}"
  changed_when: "'linger added' in linger_result.stdout | default('')"
  register: linger_result
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc != 0
  failed_when: false

- name: Remove downloaded Docker Desktop package
  ansible.builtin.file:
    path: /tmp/docker-desktop.deb
    state: absent
  when:
    - docker_desktop_should_install
    - docker_desktop_check.rc != 0

- name: Docker Desktop summary
  ansible.builtin.debug:
    msg: "Docker Desktop install attempted (effective_install={{ docker_desktop_should_install }})."
  when: docker_desktop_install
