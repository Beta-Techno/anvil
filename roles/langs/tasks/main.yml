---
# Install base build toolchain first (needed by all language builds)
- name: Install base build toolchain
  ansible.builtin.apt:
    name: "{{ langs_build_toolchain_packages }}"
    state: present
    update_cache: true
  become: true
  when: langs_install_build_toolchain

- name: Ensure shell config directory exists
  ansible.builtin.file:
    path: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell"
    state: directory
    mode: "0755"
  become: false

- name: Create PATH shell configuration for ~/.local/bin
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/path.sh"
    mode: "0644"
    content: |
      # Add ~/.local/bin to PATH for user-installed binaries
      export PATH="$HOME/.local/bin:$PATH"
  become: false

- name: Ensure shell configs are sourced in shell rc files
  ansible.builtin.blockinfile:
    path: "{{ item }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - source shell configs"
    block: |
      # Source all shell configurations from ~/.config/shell/
      if [ -d "$HOME/.config/shell" ]; then
        for config in "$HOME/.config/shell"/*.sh; do
          [ -r "$config" ] && . "$config"
        done
      fi
    create: true
  loop:
    - "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.bashrc"
    - "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.zshrc"
  become: false

- name: Ensure Python build dependencies are installed
  ansible.builtin.apt:
    name: "{{ langs_pyenv_build_deps }}"
    state: present
    update_cache: true
  become: true
  when: langs_install_python

- name: Install nvm
  ansible.builtin.git:
    repo: https://github.com/nvm-sh/nvm.git
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.nvm"
    version: "{{ langs_nvm_version }}"
  become: false
  when: langs_install_node

- name: Install Node.js LTS with nvm
  ansible.builtin.shell: |
    set -e
    export NVM_DIR="{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
    nvm install --lts
    nvm alias default "{{ langs_node_default }}"
  args:
    executable: /bin/bash
    creates: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.nvm/alias/default"
  become: false
  when: langs_install_node

- name: Create nvm shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/nvm.sh"
    mode: "0644"
    content: |
      # nvm (Node Version Manager)
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
  become: false
  when: langs_install_node

- name: Install pnpm globally via npm
  ansible.builtin.shell: |
    set -e
    export NVM_DIR="{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
    npm install -g pnpm
  args:
    executable: /bin/bash
  become: false
  when:
    - langs_install_node
    - langs_install_pnpm

- name: Install pyenv
  ansible.builtin.git:
    repo: https://github.com/pyenv/pyenv.git
    dest: "{{ langs_pyenv_root }}"
  become: false
  when: langs_install_python

- name: Create pyenv shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/pyenv.sh"
    mode: "0644"
    content: |
      # pyenv (Python Version Manager)
      export PYENV_ROOT="{{ langs_pyenv_root }}"
      command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init -)"
  become: false
  when: langs_install_python

- name: Install Python via pyenv
  ansible.builtin.shell: |
    set -e
    export PYENV_ROOT="{{ langs_pyenv_root }}"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    pyenv install -s "{{ langs_pyenv_python_version }}"
    pyenv global "{{ langs_pyenv_python_version }}"
  args:
    executable: /bin/bash
  environment:
    PYENV_ROOT: "{{ langs_pyenv_root }}"
    PATH: "{{ langs_pyenv_root }}/bin:{{ langs_pyenv_root }}/shims:{{ ansible_env.PATH }}"
  become: false
  when: langs_install_python

- name: Install pipx
  ansible.builtin.shell: |
    set -e
    export PYENV_ROOT="{{ langs_pyenv_root }}"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    pip install --user pipx
    pipx ensurepath
  args:
    executable: /bin/bash
  environment:
    PYENV_ROOT: "{{ langs_pyenv_root }}"
    PATH: "{{ langs_pyenv_root }}/bin:{{ langs_pyenv_root }}/shims:{{ ansible_env.PATH }}"
  become: false
  when:
    - langs_install_python
    - langs_install_pipx

- name: Install uv
  ansible.builtin.shell: |
    set -e
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.cargo/bin/uv"
  become: false
  when:
    - langs_install_python
    - langs_install_uv

- name: Install Ruby build dependencies
  ansible.builtin.apt:
    name: "{{ langs_ruby_build_deps }}"
    state: present
    update_cache: true
  become: true
  when: langs_install_ruby

- name: Install rbenv from source
  ansible.builtin.git:
    repo: https://github.com/rbenv/rbenv.git
    dest: "{{ langs_rbenv_root }}"
    version: master
  become: false
  when: langs_install_ruby

- name: Install ruby-build plugin
  ansible.builtin.git:
    repo: https://github.com/rbenv/ruby-build.git
    dest: "{{ langs_rbenv_root }}/plugins/ruby-build"
    version: master
  become: false
  when: langs_install_ruby

- name: Install Ruby via rbenv
  ansible.builtin.shell: |
    set -e
    export RBENV_ROOT="{{ langs_rbenv_root }}"
    export PATH="$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH"
    rbenv install -s "{{ langs_rbenv_ruby_version }}"
    rbenv global "{{ langs_rbenv_ruby_version }}"
  args:
    executable: /bin/bash
  environment:
    RBENV_ROOT: "{{ langs_rbenv_root }}"
    PATH: "{{ langs_rbenv_root }}/bin:{{ langs_rbenv_root }}/shims:{{ ansible_env.PATH }}"
  become: false
  when: langs_install_ruby

- name: Create rbenv shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/rbenv.sh"
    mode: "0644"
    content: |
      # rbenv (Ruby Version Manager)
      export RBENV_ROOT="{{ langs_rbenv_root }}"
      export PATH="$RBENV_ROOT/bin:$PATH"
      eval "$(rbenv init - bash)"
  become: false
  when: langs_install_ruby

- name: Check installed Go version
  ansible.builtin.command: /usr/local/go/bin/go version
  register: go_version_check
  changed_when: false
  failed_when: false
  when: langs_install_go

- name: Remove existing Go installation if version differs
  ansible.builtin.file:
    path: /usr/local/go
    state: absent
  become: true
  when:
    - langs_install_go
    - go_version_check.stdout is defined
    - ("go" + langs_go_version) not in go_version_check.stdout

- name: Download Go archive
  ansible.builtin.get_url:
    url: "{{ langs_go_download_url }}"
    dest: /tmp/go.tar.gz
    mode: "0644"
  when:
    - langs_install_go
    - go_version_check.stdout is not defined or ("go" + langs_go_version) not in go_version_check.stdout

- name: Install Go to /usr/local
  ansible.builtin.unarchive:
    src: /tmp/go.tar.gz
    dest: /usr/local
    remote_src: true
  become: true
  when:
    - langs_install_go
    - go_version_check.stdout is not defined or ("go" + langs_go_version) not in go_version_check.stdout

- name: Create Go shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/go.sh"
    mode: "0644"
    content: |
      # Go
      export PATH="/usr/local/go/bin:$PATH"
      export PATH="$HOME/go/bin:$PATH"
      export GOPATH="$HOME/go"
  become: false
  when: langs_install_go

- name: Install golangci-lint
  ansible.builtin.shell: |
    set -e
    curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/go/bin/golangci-lint"
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
  become: false
  when:
    - langs_install_go
    - langs_install_golangci_lint

- name: Install air for live reload
  ansible.builtin.shell: |
    set -e
    go install github.com/air-verse/air@latest
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/go/bin/air"
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
    GOPATH: "{{ ansible_env.HOME }}/go"
  become: false
  when:
    - langs_install_go
    - langs_install_air

- name: Install Rust toolchain (rustup)
  ansible.builtin.shell: |
    set -e
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.cargo/bin/rustc"
  become: false
  when: langs_install_rust

- name: Create Rust shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/rust.sh"
    mode: "0644"
    content: |
      # Rust
      . "$HOME/.cargo/env"
  become: false
  when: langs_install_rust

- name: Install cargo-edit
  ansible.builtin.shell: |
    set -e
    . "$HOME/.cargo/env"
    cargo install cargo-edit
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-add"
  become: false
  when:
    - langs_install_rust
    - langs_install_cargo_edit

- name: Install cargo-watch
  ansible.builtin.shell: |
    set -e
    . "$HOME/.cargo/env"
    cargo install cargo-watch
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-watch"
  become: false
  when:
    - langs_install_rust
    - langs_install_cargo_watch

- name: Install cargo-audit
  ansible.builtin.shell: |
    set -e
    . "$HOME/.cargo/env"
    cargo install cargo-audit
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-audit"
  become: false
  when:
    - langs_install_rust
    - langs_install_cargo_audit

# .NET SDK installation
- name: Add Microsoft package repository GPG key
  ansible.builtin.get_url:
    url: https://packages.microsoft.com/config/ubuntu/{{ ansible_distribution_version }}/packages-microsoft-prod.deb
    dest: /tmp/packages-microsoft-prod.deb
    mode: "0644"
  when: langs_install_dotnet

- name: Install Microsoft package repository
  ansible.builtin.apt:
    deb: /tmp/packages-microsoft-prod.deb
  become: true
  when: langs_install_dotnet

- name: Install .NET SDK
  ansible.builtin.apt:
    name: "dotnet-sdk-{{ langs_dotnet_version }}"
    state: present
    update_cache: true
  become: true
  when: langs_install_dotnet

- name: Install Entity Framework tool
  ansible.builtin.shell: |
    set -e
    dotnet tool install --global dotnet-ef
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.dotnet/tools/dotnet-ef"
  become: false
  when:
    - langs_install_dotnet
    - langs_install_dotnet_ef

- name: Create .NET shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/dotnet.sh"
    mode: "0644"
    content: |
      # .NET
      export PATH="$HOME/.dotnet/tools:$PATH"
      export DOTNET_CLI_TELEMETRY_OPTOUT=1
  become: false
  when: langs_install_dotnet

- name: Install Java (default-jdk)
  ansible.builtin.apt:
    name: default-jdk
    state: present
    update_cache: true
  become: true
  when: langs_install_java

# rtx version manager (optional)
- name: Install rtx
  ansible.builtin.shell: |
    set -e
    curl https://rtx.pub/install.sh | sh
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.local/bin/rtx"
  become: false
  when: langs_install_rtx

- name: Create rtx shell configuration
  ansible.builtin.copy:
    dest: "{{ lookup('env','HOME') | default(ansible_env.HOME, true) }}/.config/shell/rtx.sh"
    mode: "0644"
    content: |
      # rtx version manager
      eval "$(~/.local/bin/rtx activate bash)"
  become: false
  when: langs_install_rtx

- name: Langs summary
  ansible.builtin.debug:
    msg: |
      Languages and toolchains installed:
        - Build toolchain: {{ langs_install_build_toolchain }}
        - Node.js: {{ langs_install_node }} (pnpm={{ langs_install_pnpm }})
        - Python: {{ langs_install_python }} (pipx={{ langs_install_pipx }}, uv={{ langs_install_uv }})
        - Ruby: {{ langs_install_ruby }}
        - Go: {{ langs_install_go }} (golangci-lint={{ langs_install_golangci_lint }}, air={{ langs_install_air }})
        - Rust: {{ langs_install_rust }} (cargo-edit={{ langs_install_cargo_edit }}, cargo-watch={{ langs_install_cargo_watch }}, cargo-audit={{ langs_install_cargo_audit }})
        - .NET: {{ langs_install_dotnet }} (dotnet-ef={{ langs_install_dotnet_ef }})
        - Java: {{ langs_install_java }}
        - rtx: {{ langs_install_rtx }}
