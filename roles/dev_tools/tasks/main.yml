---
- name: Skip dev tools when disabled
  ansible.builtin.debug:
    msg: "Dev tools install skipped (dev_tools_install=false)."
  when: not dev_tools_install

- name: Install database clients
  ansible.builtin.apt:
    name: "{{ dev_tools_database_clients }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install git enhancements
  ansible.builtin.apt:
    name: "{{ dev_tools_git_extras }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install data processing tools
  ansible.builtin.apt:
    name: "{{ dev_tools_data_tools }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install network and API tools
  ansible.builtin.apt:
    name: "{{ dev_tools_network_tools }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install modern CLI tools
  ansible.builtin.apt:
    name: "{{ dev_tools_modern_cli }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install system monitoring tools
  ansible.builtin.apt:
    name: "{{ dev_tools_monitoring }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install secret management tools
  ansible.builtin.apt:
    name: "{{ dev_tools_secrets }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

# sops installation
- name: Check if sops is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_sops_install_path }}"
  register: sops_binary
  when:
    - dev_tools_install
    - dev_tools_install_sops

- name: Download sops binary
  ansible.builtin.get_url:
    url: "{{ dev_tools_sops_url }}"
    dest: "{{ dev_tools_sops_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_sops
    - not sops_binary.stat.exists

# Bitwarden CLI installation
- name: Check if snapd is available for Bitwarden CLI
  ansible.builtin.command: which snap
  register: snap_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli

- name: Install Bitwarden CLI via snap
  community.general.snap:
    name: bw
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli
    - snap_check.rc == 0

- name: Warn if snapd not available for Bitwarden CLI
  ansible.builtin.debug:
    msg: "Bitwarden CLI requires snapd. Install snapd or use npm: npm install -g @bitwarden/cli"
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli
    - snap_check.rc != 0

# Terraform installation
- name: Add HashiCorp GPG key for Terraform
  ansible.builtin.apt_key:
    url: "{{ dev_tools_terraform_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

- name: Add HashiCorp repository for Terraform
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_terraform_repo }}"
    state: present
    filename: hashicorp
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

- name: Install Terraform
  ansible.builtin.apt:
    name: terraform
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

# Terragrunt installation
- name: Check if Terragrunt is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_terragrunt_install_path }}"
  register: terragrunt_binary
  when:
    - dev_tools_install
    - dev_tools_install_terragrunt

- name: Download Terragrunt binary
  ansible.builtin.get_url:
    url: "{{ dev_tools_terragrunt_url }}"
    dest: "{{ dev_tools_terragrunt_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terragrunt
    - not terragrunt_binary.stat.exists

# ngrok installation
- name: Add ngrok GPG key
  ansible.builtin.apt_key:
    url: "{{ dev_tools_ngrok_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

- name: Add ngrok repository
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_ngrok_repo }}"
    state: present
    filename: ngrok
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

- name: Install ngrok
  ansible.builtin.apt:
    name: ngrok
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

# kubectl installation
- name: Add Kubernetes GPG key for kubectl
  ansible.builtin.apt_key:
    url: "{{ dev_tools_kubectl_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

- name: Add Kubernetes repository for kubectl
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_kubectl_repo }}"
    state: present
    filename: kubernetes
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

- name: Install kubectl
  ansible.builtin.apt:
    name: kubectl
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

# Helm installation
- name: Check if Helm is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_helm_install_path }}"
  register: helm_binary
  when:
    - dev_tools_install
    - dev_tools_install_helm

- name: Install Helm via official script
  ansible.builtin.shell: |
    curl -fsSL {{ dev_tools_helm_install_script }} | bash
  args:
    executable: /bin/bash
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_helm
    - not helm_binary.stat.exists

# k9s installation
- name: Check if k9s is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_k9s_install_path }}"
  register: k9s_binary
  when:
    - dev_tools_install
    - dev_tools_install_k9s

- name: Download and extract k9s
  ansible.builtin.unarchive:
    src: "{{ dev_tools_k9s_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

- name: Install k9s binary
  ansible.builtin.copy:
    src: /tmp/k9s
    dest: "{{ dev_tools_k9s_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

- name: Clean up k9s temp files
  ansible.builtin.file:
    path: /tmp/k9s
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

# AWS CLI installation
- name: Install AWS CLI
  ansible.builtin.apt:
    name: awscli
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli

# Google Cloud SDK installation
- name: Add Google Cloud GPG key
  ansible.builtin.apt_key:
    url: "{{ dev_tools_gcloud_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

- name: Add Google Cloud SDK repository
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_gcloud_repo }}"
    state: present
    filename: google-cloud-sdk
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

- name: Install Google Cloud SDK
  ansible.builtin.apt:
    name: google-cloud-cli
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

# dust installation (Rust tool via cargo)
- name: Check if cargo is available for dust
  ansible.builtin.command: which cargo
  register: cargo_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_install
    - dev_tools_install_dust

- name: Install dust via cargo
  ansible.builtin.command: cargo install du-dust
  when:
    - dev_tools_install
    - dev_tools_install_dust
    - cargo_check.rc == 0
  register: dust_install
  changed_when: "'Installing' in dust_install.stderr"
  failed_when: false

- name: Warn if cargo not available for dust
  ansible.builtin.debug:
    msg: "dust requires cargo (Rust). Enable langs_install_rust=true to install Rust toolchain."
  when:
    - dev_tools_install
    - dev_tools_install_dust
    - cargo_check.rc != 0

- name: Dev tools summary
  ansible.builtin.debug:
    msg: |
      Dev tools installed (dev_tools_install={{ dev_tools_install }}):
        - Database clients: {{ dev_tools_database_clients | join(', ') }}
        - Git extras: {{ dev_tools_git_extras | join(', ') }}
        - Data tools: {{ dev_tools_data_tools | join(', ') }}
        - Network tools: {{ dev_tools_network_tools | join(', ') }}
        - Modern CLI: {{ dev_tools_modern_cli | join(', ') }}
        - Monitoring: {{ dev_tools_monitoring | join(', ') }}
        - Secrets: {{ dev_tools_secrets | join(', ') }}
        - sops: {{ dev_tools_install_sops }}
        - Terraform: {{ dev_tools_install_terraform }}
        - Terragrunt: {{ dev_tools_install_terragrunt }}
        - ngrok: {{ dev_tools_install_ngrok }}
        - Bitwarden CLI: {{ dev_tools_install_bitwarden_cli }}
        - kubectl: {{ dev_tools_install_kubectl }}
        - Helm: {{ dev_tools_install_helm }}
        - k9s: {{ dev_tools_install_k9s }}
        - AWS CLI: {{ dev_tools_install_aws_cli }}
        - Google Cloud SDK: {{ dev_tools_install_gcloud }}
        - dust (cargo): {{ dev_tools_install_dust }}
  when: dev_tools_install
