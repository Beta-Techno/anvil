---
- name: Skip dev tools when disabled
  ansible.builtin.debug:
    msg: "Dev tools install skipped (dev_tools_install=false)."
  when: not dev_tools_install

- name: Install database clients
  ansible.builtin.apt:
    name: "{{ dev_tools_database_clients }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install git enhancements
  ansible.builtin.apt:
    name: "{{ dev_tools_git_extras }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install DevOps and CI/CD tools
  ansible.builtin.apt:
    name: "{{ dev_tools_devops }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install data processing tools
  ansible.builtin.apt:
    name: "{{ dev_tools_data_tools }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install network and API tools
  ansible.builtin.apt:
    name: "{{ dev_tools_network_tools }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install modern CLI tools
  ansible.builtin.apt:
    name: "{{ dev_tools_modern_cli }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install system monitoring tools
  ansible.builtin.apt:
    name: "{{ dev_tools_monitoring }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

- name: Install secret management tools
  ansible.builtin.apt:
    name: "{{ dev_tools_secrets }}"
    state: present
    update_cache: true
  become: true
  when: dev_tools_install

# sops installation
- name: Check if sops is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_sops_install_path }}"
  register: sops_binary
  when:
    - dev_tools_install
    - dev_tools_install_sops

- name: Download sops binary
  ansible.builtin.get_url:
    url: "{{ dev_tools_sops_url }}"
    dest: "{{ dev_tools_sops_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_sops
    - not sops_binary.stat.exists

# Bitwarden CLI installation
- name: Check if snapd is available for Bitwarden CLI
  ansible.builtin.command: which snap
  register: snap_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli

- name: Install Bitwarden CLI via snap
  community.general.snap:
    name: bw
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli
    - snap_check.rc == 0

- name: Warn if snapd not available for Bitwarden CLI
  ansible.builtin.debug:
    msg: "Bitwarden CLI requires snapd. Install snapd or use npm: npm install -g @bitwarden/cli"
  when:
    - dev_tools_install
    - dev_tools_install_bitwarden_cli
    - snap_check.rc != 0

# Terraform installation
- name: Add HashiCorp GPG key for Terraform
  ansible.builtin.apt_key:
    url: "{{ dev_tools_terraform_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

- name: Add HashiCorp repository for Terraform
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_terraform_repo }}"
    state: present
    filename: hashicorp
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

- name: Install Terraform
  ansible.builtin.apt:
    name: terraform
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terraform

# Terragrunt installation
- name: Check if Terragrunt is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_terragrunt_install_path }}"
  register: terragrunt_binary
  when:
    - dev_tools_install
    - dev_tools_install_terragrunt

- name: Download Terragrunt binary
  ansible.builtin.get_url:
    url: "{{ dev_tools_terragrunt_url }}"
    dest: "{{ dev_tools_terragrunt_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_terragrunt
    - not terragrunt_binary.stat.exists

# ngrok installation
- name: Add ngrok GPG key
  ansible.builtin.apt_key:
    url: "{{ dev_tools_ngrok_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

- name: Add ngrok repository
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_ngrok_repo }}"
    state: present
    filename: ngrok
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

- name: Install ngrok
  ansible.builtin.apt:
    name: ngrok
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ngrok

# kubectl installation
- name: Add Kubernetes GPG key for kubectl
  ansible.builtin.apt_key:
    url: "{{ dev_tools_kubectl_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

- name: Add Kubernetes repository for kubectl
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_kubectl_repo }}"
    state: present
    filename: kubernetes
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

- name: Install kubectl
  ansible.builtin.apt:
    name: kubectl
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kubectl

# Helm installation
- name: Check if Helm is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_helm_install_path }}"
  register: helm_binary
  when:
    - dev_tools_install
    - dev_tools_install_helm

- name: Install Helm via official script
  ansible.builtin.shell: |
    curl -fsSL {{ dev_tools_helm_install_script }} | bash
  args:
    executable: /bin/bash
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_helm
    - not helm_binary.stat.exists

# k9s installation
- name: Check if k9s is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_k9s_install_path }}"
  register: k9s_binary
  when:
    - dev_tools_install
    - dev_tools_install_k9s

- name: Download and extract k9s
  ansible.builtin.unarchive:
    src: "{{ dev_tools_k9s_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

- name: Install k9s binary
  ansible.builtin.copy:
    src: /tmp/k9s
    dest: "{{ dev_tools_k9s_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

- name: Clean up k9s temp files
  ansible.builtin.file:
    path: /tmp/k9s
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_k9s
    - not k9s_binary.stat.exists

# AWS CLI v2 installation
- name: Check if AWS CLI is already installed
  ansible.builtin.command: aws --version
  register: aws_cli_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli

- name: Download AWS CLI v2 installer
  ansible.builtin.get_url:
    url: "{{ dev_tools_aws_cli_zip_url }}"
    dest: /tmp/awscliv2.zip
    mode: "0644"
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli
    - aws_cli_check.rc != 0

- name: Ensure unzip is installed for AWS CLI
  ansible.builtin.apt:
    name: unzip
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli
    - aws_cli_check.rc != 0

- name: Extract AWS CLI v2 installer
  ansible.builtin.unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli
    - aws_cli_check.rc != 0

- name: Install AWS CLI v2
  ansible.builtin.command: /tmp/aws/install
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli
    - aws_cli_check.rc != 0

- name: Clean up AWS CLI installer files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/awscliv2.zip
    - /tmp/aws
  when:
    - dev_tools_install
    - dev_tools_install_aws_cli
    - aws_cli_check.rc != 0

# Google Cloud SDK installation
- name: Add Google Cloud GPG key
  ansible.builtin.apt_key:
    url: "{{ dev_tools_gcloud_gpg_url }}"
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

- name: Add Google Cloud SDK repository
  ansible.builtin.apt_repository:
    repo: "{{ dev_tools_gcloud_repo }}"
    state: present
    filename: google-cloud-sdk
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

- name: Install Google Cloud SDK
  ansible.builtin.apt:
    name: google-cloud-cli
    state: present
    update_cache: true
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_gcloud

# lazygit installation
- name: Check if lazygit is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_lazygit_install_path }}"
  register: lazygit_binary
  when:
    - dev_tools_install
    - dev_tools_install_lazygit

- name: Download and extract lazygit
  ansible.builtin.unarchive:
    src: "{{ dev_tools_lazygit_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_lazygit
    - not lazygit_binary.stat.exists

- name: Install lazygit binary
  ansible.builtin.copy:
    src: /tmp/lazygit
    dest: "{{ dev_tools_lazygit_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_lazygit
    - not lazygit_binary.stat.exists

- name: Clean up lazygit temp files
  ansible.builtin.file:
    path: /tmp/lazygit
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_lazygit
    - not lazygit_binary.stat.exists

# delta installation
- name: Check if delta is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_delta_install_path }}"
  register: delta_binary
  when:
    - dev_tools_install
    - dev_tools_install_delta

- name: Download and extract delta
  ansible.builtin.unarchive:
    src: "{{ dev_tools_delta_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_delta
    - not delta_binary.stat.exists

- name: Find extracted delta binary
  ansible.builtin.find:
    paths: /tmp
    patterns: "delta-*"
    file_type: directory
  register: delta_dir
  when:
    - dev_tools_install
    - dev_tools_install_delta
    - not delta_binary.stat.exists

- name: Install delta binary
  ansible.builtin.copy:
    src: "{{ delta_dir.files[0].path }}/delta"
    dest: "{{ dev_tools_delta_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_delta
    - not delta_binary.stat.exists
    - delta_dir.files | length > 0

- name: Clean up delta temp files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ delta_dir.files | map(attribute='path') | list }}"
  when:
    - dev_tools_install
    - dev_tools_install_delta
    - not delta_binary.stat.exists
    - delta_dir.files | length > 0

# ghorg installation
- name: Check if ghorg is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_ghorg_install_path }}"
  register: ghorg_binary
  when:
    - dev_tools_install
    - dev_tools_install_ghorg

- name: Download and extract ghorg
  ansible.builtin.unarchive:
    src: "{{ dev_tools_ghorg_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_ghorg
    - not ghorg_binary.stat.exists

- name: Install ghorg binary
  ansible.builtin.copy:
    src: /tmp/ghorg
    dest: "{{ dev_tools_ghorg_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_ghorg
    - not ghorg_binary.stat.exists

- name: Clean up ghorg temp files
  ansible.builtin.file:
    path: /tmp/ghorg
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_ghorg
    - not ghorg_binary.stat.exists

# dust installation (Rust tool via cargo)
- name: Check if cargo is available for dust
  ansible.builtin.command: which cargo
  register: cargo_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_install
    - dev_tools_install_dust

- name: Install dust via cargo
  ansible.builtin.command: cargo install du-dust
  when:
    - dev_tools_install
    - dev_tools_install_dust
    - cargo_check.rc == 0
  register: dust_install
  changed_when: "'Installing' in dust_install.stderr"
  failed_when: false

- name: Warn if cargo not available for dust
  ansible.builtin.debug:
    msg: "dust requires cargo (Rust). Enable langs_install_rust=true to install Rust toolchain."
  when:
    - dev_tools_install
    - dev_tools_install_dust
    - cargo_check.rc != 0

# doctl installation
- name: Check if doctl is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_doctl_install_path }}"
  register: doctl_binary
  when:
    - dev_tools_install
    - dev_tools_install_doctl

- name: Download and extract doctl
  ansible.builtin.unarchive:
    src: "{{ dev_tools_doctl_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_doctl
    - not doctl_binary.stat.exists

- name: Install doctl binary
  ansible.builtin.copy:
    src: /tmp/doctl
    dest: "{{ dev_tools_doctl_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_doctl
    - not doctl_binary.stat.exists

- name: Clean up doctl temp files
  ansible.builtin.file:
    path: /tmp/doctl
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_doctl
    - not doctl_binary.stat.exists

# act installation
- name: Check if act is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_act_install_path }}"
  register: act_binary
  when:
    - dev_tools_install
    - dev_tools_install_act

- name: Download and extract act
  ansible.builtin.unarchive:
    src: "{{ dev_tools_act_url }}"
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_act
    - not act_binary.stat.exists

- name: Install act binary
  ansible.builtin.copy:
    src: /tmp/act
    dest: "{{ dev_tools_act_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_act
    - not act_binary.stat.exists

- name: Clean up act temp files
  ansible.builtin.file:
    path: /tmp/act
    state: absent
  when:
    - dev_tools_install
    - dev_tools_install_act
    - not act_binary.stat.exists

# Packer installation
- name: Check if Packer is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_packer_install_path }}"
  register: packer_binary
  when:
    - dev_tools_install
    - dev_tools_install_packer

- name: Download Packer zip
  ansible.builtin.get_url:
    url: "{{ dev_tools_packer_url }}"
    dest: /tmp/packer.zip
    mode: "0644"
  when:
    - dev_tools_install
    - dev_tools_install_packer
    - not packer_binary.stat.exists

- name: Ensure unzip is installed for Packer
  ansible.builtin.apt:
    name: unzip
    state: present
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_packer
    - not packer_binary.stat.exists

- name: Extract Packer
  ansible.builtin.unarchive:
    src: /tmp/packer.zip
    dest: /tmp
    remote_src: true
  when:
    - dev_tools_install
    - dev_tools_install_packer
    - not packer_binary.stat.exists

- name: Install Packer binary
  ansible.builtin.copy:
    src: /tmp/packer
    dest: "{{ dev_tools_packer_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_packer
    - not packer_binary.stat.exists

- name: Clean up Packer temp files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/packer.zip
    - /tmp/packer
  when:
    - dev_tools_install
    - dev_tools_install_packer
    - not packer_binary.stat.exists

# kind installation
- name: Check if kind is already installed
  ansible.builtin.stat:
    path: "{{ dev_tools_kind_install_path }}"
  register: kind_binary
  when:
    - dev_tools_install
    - dev_tools_install_kind

- name: Download kind binary
  ansible.builtin.get_url:
    url: "{{ dev_tools_kind_url }}"
    dest: "{{ dev_tools_kind_install_path }}"
    mode: "0755"
  become: true
  when:
    - dev_tools_install
    - dev_tools_install_kind
    - not kind_binary.stat.exists

- name: Dev tools summary
  ansible.builtin.debug:
    msg: |
      Dev tools installed (dev_tools_install={{ dev_tools_install }}):
        - Database clients: {{ dev_tools_database_clients | join(', ') }}
        - Git extras: {{ dev_tools_git_extras | join(', ') }}
        - DevOps tools: {{ dev_tools_devops | join(', ') }}
        - Data tools: {{ dev_tools_data_tools | join(', ') }}
        - Network tools: {{ dev_tools_network_tools | join(', ') }}
        - Modern CLI: {{ dev_tools_modern_cli | join(', ') }}
        - Monitoring: {{ dev_tools_monitoring | join(', ') }}
        - Secrets: {{ dev_tools_secrets | join(', ') }}
        - sops: {{ dev_tools_install_sops }}
        - lazygit: {{ dev_tools_install_lazygit }}
        - delta: {{ dev_tools_install_delta }}
        - ghorg: {{ dev_tools_install_ghorg }}
        - Terraform: {{ dev_tools_install_terraform }}
        - Terragrunt: {{ dev_tools_install_terragrunt }}
        - ngrok: {{ dev_tools_install_ngrok }}
        - Bitwarden CLI: {{ dev_tools_install_bitwarden_cli }}
        - kubectl: {{ dev_tools_install_kubectl }}
        - Helm: {{ dev_tools_install_helm }}
        - k9s: {{ dev_tools_install_k9s }}
        - doctl: {{ dev_tools_install_doctl }}
        - act: {{ dev_tools_install_act }}
        - Packer: {{ dev_tools_install_packer }}
        - kind: {{ dev_tools_install_kind }}
        - AWS CLI: {{ dev_tools_install_aws_cli }}
        - Google Cloud SDK: {{ dev_tools_install_gcloud }}
        - dust (cargo): {{ dev_tools_install_dust }}
  when: dev_tools_install
