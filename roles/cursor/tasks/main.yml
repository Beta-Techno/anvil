---
- name: Skip Cursor install when disabled
  ansible.builtin.debug:
    msg: "Cursor install skipped (cursor_install=false)."
  when: not cursor_install

- name: Determine Cursor download URL (prefer explicit)
  ansible.builtin.set_fact:
    cursor_resolved_url: "{{ cursor_deb_url }}"
  when: cursor_install

- name: Fetch Cursor download page when URL not provided
  ansible.builtin.uri:
    url: "{{ cursor_download_page }}"
    return_content: true
  register: cursor_page
  when:
    - cursor_install
    - cursor_deb_url | length == 0

- name: Extract Cursor .deb URL from page
  ansible.builtin.set_fact:
    cursor_resolved_url: >-
      {{
        (cursor_page.content | default('') | regex_findall('https://[^"]+\\.deb'))
        | select('search', tok_pattern)
        | list
        | first
      }}
  vars:
    tok_pattern: "{{ '(amd64|x64|x86_64)' if apt_arch == 'amd64' else '(arm64|aarch64)' }}"
  when:
    - cursor_install
    - cursor_deb_url | length == 0

- name: Skip Cursor if URL could not be resolved
  ansible.builtin.debug:
    msg: "No matching Cursor .deb found for arch={{ apt_arch }}; skipping Cursor install."
  when:
    - cursor_install
    - cursor_resolved_url is not defined or cursor_resolved_url | length == 0
  changed_when: false

- name: Download Cursor package
  ansible.builtin.get_url:
    url: "{{ cursor_resolved_url }}"
    dest: /tmp/cursor.deb
    mode: "0644"
    checksum: "{{ cursor_deb_checksum if cursor_deb_checksum | length > 0 else omit }}"
  when: cursor_install

- name: Install Cursor IDE
  ansible.builtin.apt:
    deb: /tmp/cursor.deb
    state: present
    update_cache: true
  register: cursor_result
  when: cursor_install

- name: Remove downloaded Cursor package
  ansible.builtin.file:
    path: /tmp/cursor.deb
    state: absent
  when: cursor_install

- name: Cursor install summary
  ansible.builtin.debug:
    msg: "Cursor install attempted (cursor_install={{ cursor_install }})."
  when: cursor_install
