---
- name: Skip Cursor install when disabled
  ansible.builtin.debug:
    msg: "Cursor install skipped (cursor_install=false)."
  when: not cursor_install

- name: Install Cursor IDE
  ansible.builtin.shell: |
    set -euo pipefail
    arch="$(dpkg --print-architecture)"
    case "$arch" in
      amd64) tok='(amd64|x64|x86_64)' ;;
      arm64) tok='(arm64|aarch64)' ;;
      *) echo "Unsupported arch: $arch" >&2; exit 1 ;;
    esac

    page="$(curl -fsSL "{{ cursor_download_page }}" || true)"
    urls="$(printf '%s' "$page" | grep -Eo 'https://[^"]+\.deb' || true)"
    url="$(printf '%s\n' "$urls" | grep -Ei "$tok" | head -n1)"
    if [[ -z "${url:-}" ]]; then
      echo "No matching .deb found for arch=$arch" >&2
      exit 2
    fi

    tmpdir="$(mktemp -d)"
    trap 'rm -rf "$tmpdir"' EXIT
    cd "$tmpdir"
    curl -fLo cursor.deb "$url"
    chmod 644 cursor.deb
    sudo apt install -y ./cursor.deb
  args:
    executable: /bin/bash
  register: cursor_result
  changed_when: cursor_result.rc == 0
  when: cursor_install

- name: Cursor install summary
  ansible.builtin.debug:
    msg: "Cursor install attempted (cursor_install={{ cursor_install }})."
  when: cursor_install
