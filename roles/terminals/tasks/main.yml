---
- name: Install Alacritty via apt
  ansible.builtin.apt:
    name: alacritty
    state: present
    update_cache: true
  when:
    - terminals_install_alacritty
    - not terminals_install_from_source

- name: Install Alacritty build dependencies
  ansible.builtin.apt:
    name:
      - git
      - curl
      - build-essential
      - cmake
      - pkg-config
      - python3
      - desktop-file-utils
      - gzip
      - ncurses-bin
      - libfreetype6-dev
      - libfontconfig1-dev
      - libxcb-xfixes0-dev
      - libxkbcommon-dev
      - libwayland-dev
      - wayland-protocols
      - libegl1-mesa-dev
    state: present
    update_cache: true
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Ensure rustup is installed for building Alacritty
  ansible.builtin.shell: |
    set -e
    if command -v cargo >/dev/null 2>&1; then
      exit 0
    fi
    curl -fsSL https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
  changed_when: true
  become: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Clone or update Alacritty source
  ansible.builtin.git:
    repo: https://github.com/alacritty/alacritty.git
    dest: "{{ terminals_source_dir }}"
    version: master
    update: true
  become: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Build Alacritty in release mode
  ansible.builtin.shell: |
    set -e
    [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
    cargo build --release
  args:
    chdir: "{{ terminals_source_dir }}"
    executable: /bin/bash
  environment:
    HOME: "{{ ansible_env.HOME }}"
  become: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Install Alacritty binary
  ansible.builtin.copy:
    src: "{{ terminals_source_dir }}/target/release/alacritty"
    dest: /usr/local/bin/alacritty
    mode: "0755"
    remote_src: true
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Install Alacritty desktop entry
  ansible.builtin.command: >
    desktop-file-install
    --set-key=Exec --set-value="/usr/local/bin/alacritty %F"
    --set-key=TryExec --set-value="/usr/local/bin/alacritty"
    "{{ terminals_source_dir }}/extra/linux/Alacritty.desktop"
  changed_when: false
  failed_when: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Install Alacritty icon
  ansible.builtin.copy:
    src: "{{ terminals_source_dir }}/extra/logo/alacritty-term.svg"
    dest: /usr/share/pixmaps/Alacritty.svg
    mode: "0644"
    remote_src: true
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Install Alacritty man page
  ansible.builtin.shell: |
    gzip -c extra/alacritty.man | sudo tee /usr/local/share/man/man1/alacritty.1.gz >/dev/null
  args:
    chdir: "{{ terminals_source_dir }}"
    executable: /bin/bash
  changed_when: false
  failed_when: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Install Alacritty terminfo entries
  ansible.builtin.shell: |
    sudo tic -xe alacritty,alacritty-direct "{{ terminals_source_dir }}/extra/alacritty.info"
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false
  when:
    - terminals_install_alacritty
    - terminals_install_from_source

- name: Terminals summary
  ansible.builtin.debug:
    msg: >-
      Terminals installed (Alacritty via {{ 'source' if terminals_install_from_source else 'apt' }}
      enabled={{ terminals_install_alacritty }}).
